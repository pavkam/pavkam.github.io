<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>queues &#8211; YAPB</title>
	<atom:link href="https://alex.ciobanu.org/?feed=rss2&#038;tag=queues" rel="self" type="application/rss+xml" />
	<link>https://alex.ciobanu.org</link>
	<description>Yet Another Programming Blog</description>
	<lastBuildDate>Mon, 28 May 2018 07:01:42 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.2.2</generator>

<image>
	<url>https://alex.ciobanu.org/files/uploads/2018/05/7327309-150x150.jpg</url>
	<title>queues &#8211; YAPB</title>
	<link>https://alex.ciobanu.org</link>
	<width>32</width>
	<height>32</height>
</image> 
	<item>
		<title>Rate limiting an Azure queue</title>
		<link>https://alex.ciobanu.org/?p=680</link>
				<comments>https://alex.ciobanu.org/?p=680#respond</comments>
				<pubDate>Sat, 02 Jun 2018 20:00:23 +0000</pubDate>
		<dc:creator><![CDATA[Alexandru Ciobanu]]></dc:creator>
				<category><![CDATA[Software Development]]></category>
		<category><![CDATA[azure]]></category>
		<category><![CDATA[function apps]]></category>
		<category><![CDATA[microsoft]]></category>
		<category><![CDATA[queues]]></category>
		<category><![CDATA[service bus]]></category>

		<guid isPermaLink="false">http://alex.ciobanu.org/?p=680</guid>
				<description><![CDATA[In my previous post (&#8220;Singleton&#8221; Azure Functions) I offered a tip on how to set up an Azure function to serve as a system-wide &#8220;singleton&#8221;. One of the use cases I was looking for was to set up... ]]></description>
								<content:encoded><![CDATA[<p>In my previous post (<a href="http://alex.ciobanu.org/?p=674">&#8220;Singleton&#8221; Azure Functions</a>) I offered a tip on how to set up an Azure function to serve as a system-wide &#8220;singleton&#8221;. One of the use cases I was looking for was to set up a service to act as a &#8220;<em>broker between two Service Bus queues</em>&#8220;. I will not go into details, suffice to say, there is a requirement to only allow, let&#8217;s say, 100 messages per second to pass through the queue.</p>
<p>As I am a strong proponent of &#8220;<em>less talk, more code</em>&#8221; so here is a rough version that gets the job done:</p>
<pre class="brush: csharp; title: ; notranslate">
private static readonly SemaphoreSlim _semaphore = new new SemaphoreSlim(1, 1);
private static readonly QueueClient _outputQueueClient = new QueueClient(&quot;{connection string}&quot;);
private static double _nextDispatchAt;
private const double _rate = 100; // the rate!

/* Method creates a task scheduled to run approximately 
   at a given &quot;time&quot; */
private static Task MoveMessageToOutputQueue(Message message) 
{ 
    Contract.Assert(message != null);

    /* Get a lock to make sure _nextDispatchAt is modified 
       atomically. This is a lazy implementation but it does the job. */
    _semaphore.Wait(); 
    try 
    { 
        /* Calculate the next &quot;click&quot;. */
        var now = DateTime.UtcNow.Ticks; 
        var delta = _nextDispatchAt - now; 
        var click = TimeSpan.TicksPerMillisecond * (1000 / _rate); 
        if (delta &gt; 0) 
        { 
            /* We need to wait until the next dispatch. */ 
            var millisToWait = (_nextDispatchAt - now) / TimeSpan.TicksPerMillisecond; 
            _nextDispatchAt += click;

            /* If the number of ticks is below the millisecond 
               threshold, execute directly. */
            return millisToWait &gt; 0 ?
                Task.Delay((int)millisToWait).ContinueWith(t =&gt; _outputQueueClient.SendAsync(message)) :
                _outputQueueClient.SendAsync(message);
        }
        else 
        {
            /* The execution is direct as there is no waiting time. */ 
            _nextDispatchAt = now + click; 
            return _outputQueueClient.SendAsync(message);
        } 
    } 
    finally 
    { 
        _semaphore.Release();
    }
}

/* This is the actual Azure function which is set up to listen on the &quot;input-queue&quot; */
[FunctionName(nameof(MoveMessageFromInputToOutput))]
public static async Task MoveMessageFromInputToOutput(
[ServiceBusTrigger(&quot;input-queue&quot;)] Microsoft.ServiceBus.Messaging.BrokeredMessage message, 
TraceWriter log)
{
    Contract.Assert(message != null);
    Contract.Assert(log != null);
    log.Debug($&quot;Moving incoming message with label \&quot;{message.Label}\&quot; ...&quot;);

    /* Make a copy of the message (just the body and whatever fields are interesting). */
    Message outputMessage;
    using (var ms = new MemoryStream())
    {
        await message.GetBody&lt;Stream&gt;().CopyToAsync(ms).ConfigureAwait(false);
        outputMessage = new Message(ms.ToArray())
        {
            Label = message.Label,
            ContentType = message.ContentType
        };
    }

    await MoveMessageToOutputQueue(outputMessage).ConfigureAwait(false);
}
</pre>
<p>To make sure the higher rates are handled, and that the function does not starve, one can update the <em>host.json</em> as follows:</p>
<pre class="brush: jscript; title: ; notranslate">
{
    &quot;serviceBus&quot;: {
        &quot;maxConcurrentCalls&quot;: 32, // Threads will mostly be awaiting
        &quot;prefetchCount&quot;: 256 // The more the merrier
    }
}
</pre>
<p>After some testing it turns out that the rate limiter is almost perfect on &#8220;<em>low rates</em>&#8221; such as <strong>100 messages/second</strong>. Due limitations of the Service Bus and other factors this code <strong>will not surpass ~600 messages/second</strong>. In such cases, multiple instances of the rate limiter should be deployed, and dividing the load between them.</p>
]]></content:encoded>
							<wfw:commentRss>https://alex.ciobanu.org/?feed=rss2&#038;p=680</wfw:commentRss>
		<slash:comments>0</slash:comments>
							</item>
	</channel>
</rss>
